Ext.define("NLeSC.eEcology.form.field.Color",{extend:Ext.form.field.Picker,alias:"widget.colorfield",triggerCls:Ext.baseCSSPrefix+"form-date-trigger",matchFieldWidth:false,allowBlank:false,maskRe:/[0-9A-F]/,colors:["000000","993300","333300","003300","003366","000080","333399","333333","800000","FF6600","808000","008000","008080","0000FF","666699","808080","FF0000","FF9900","99CC00","339966","33CCCC","3366FF","800080","969696","FF00FF","FFCC00","FFFF00","00FF00","00FFFF","00CCFF","993366","C0C0C0","FF99CC","FFCC99","FFFF99","CCFFCC","CCFFFF","99CCFF","CC99FF","FFFFFF"],pickerCls:Ext.baseCSSPrefix+"form-color-picker",createPicker:function(){var a=this;return Ext.create("Ext.picker.Color",{pickerField:a,ownerCt:a.ownerCt,renderTo:document.body,floating:true,hidden:true,focusOnShow:true,colors:a.colors,cls:a.pickerCls,listeners:{select:a.onSelect,scope:a},keyNavConfig:{esc:function(){a.collapse()}}})},onSelect:function(a,c){var b=this;b.setValue(c);b.setFieldStyle({background:"#"+c});b.fireEvent("select",b,c);b.collapse()},onExpand:function(){var a=this.getValue();this.picker.select(a,true)},validator:function(){var a=this.getValue();if(/^[0-9A-F]{6}$/.test(a)){return true}return"Color format is RRGGBB-digit hex code"}});Ext.define("NLeSC.eEcology.form.field.TrackerCombo",{extend:Ext.form.field.ComboBox,alias:"widget.trackercombo",store:"trackers",displayField:"id",allowBlank:false,fieldLabel:"Tracker",labelAttrTpl:'data-qtip="Tracker identifier aka device_info_serial"',name:"id"});Ext.define("NLeSC.eEcology.model.Project",{extend:Ext.data.Model,fields:[{name:"id",type:"string"},{name:"text",type:"string"}]});Ext.define("NLeSC.eEcology.store.Projects",{extend:Ext.data.Store,storeId:"projects",model:"NLeSC.eEcology.model.Project",proxy:{type:"ajax",url:"../../projects.json",reader:{type:"json"}},sorters:[{property:"id",direction:"ASC"}]});Ext.define("NLeSC.eEcology.model.Species",{extend:Ext.data.Model,fields:[{name:"id",type:"string"},{name:"text",type:"string"}]});Ext.define("NLeSC.eEcology.store.Species",{extend:Ext.data.Store,storeId:"species",model:"NLeSC.eEcology.model.Species",proxy:{type:"ajax",url:"../../species.json",reader:{type:"json"}},sorters:[{property:"id",direction:"ASC"}]});Ext.define("NLeSC.eEcology.model.Tracker",{extend:Ext.data.Model,fields:[{name:"id",type:"int"},"species","project"]});Ext.define("NLeSC.eEcology.store.Trackers",{extend:Ext.data.Store,storeId:"trackers",model:"NLeSC.eEcology.model.Tracker",proxy:{type:"ajax",url:"../../trackers.json",reader:{root:"trackers",type:"json"},writer:"json"},sorters:[{property:"id",direction:"ASC"}]});Ext.define("NLeSC.eEcology.grid.Trackers",{extend:Ext.grid.Panel,alias:"widget.trackersgrid",features:[{ftype:"filters",local:true}],store:"trackers",columns:[{text:"ID",sortable:true,dataIndex:"id",filter:{type:"numeric"}},{text:"Species",flex:1,sortable:true,dataIndex:"species",filter:{type:"list",store:"species"}},{text:"Project",flex:1,sortable:true,dataIndex:"project",filter:{type:"list",store:"projects"}}],initComponent:function(){this.columns.forEach(function(a){if("filter" in a&&"store" in a.filter&&typeof a.filter.store==="string"){a.filter.store=Ext.StoreManager.lookup(a.filter.store)}});this.callParent()}});Ext.define("NLeSC.eEcology.form.field.TrackerGrid",{extend:Ext.form.FieldContainer,mixins:{field:Ext.form.field.Field},grid:{xtype:"trackersgrid"},alias:"widget.trackergridfield",fieldLabel:"Tracker",name:"id",blankText:"No tracker selected",msgTarget:"under",defaults:{flex:1},layout:{type:"hbox",align:"stretch"},autoWidth:true,height:300,initComponent:function(){this.grid.selModel=Ext.create("Ext.selection.CheckboxModel",{mode:"SINGLE",showHeaderCheckbox:false});this.grid.selModel.on("selectionchange",this.onSelectionChange,this);this.items=[this.grid];this.callParent();this.initField()},getSelectionModel:function(){return this.grid.selModel},getValue:function(){var a=this.getSelectionModel();if(a.hasSelection()){return a.getSelection()[0].getId()}return null},setValue:function(d){var c=this.getSelectionModel();var b=c.getStore();if(b===undefined){return}var a=b.getById(d);c.select(a);this.mixins.field.setValue.call(this,d)},getErrors:function(){var a=this.getValue();if(a===null){return[this.blankText]}return[]},reset:function(){var a=this.getSelectionModel();a.deselectAll()},onSelectionChange:function(a,b){if(b.length>0){this.setValue(b[0].getId())}},isValid:function(){var b=this,a=b.disabled,c=b.forceValidation||!a;return c?b.validateValue(b.value):a},validateValue:function(b){var a=this,d=a.getErrors(b),c=Ext.isEmpty(d);if(!a.preventMark){if(c){a.clearInvalid()}else{a.markInvalid(d)}}return c},markInvalid:function(c){var b=this,a=b.getActiveError();b.setActiveErrors(Ext.Array.from(c));if(a!==b.getActiveError()){b.updateLayout()}},clearInvalid:function(){var b=this,a=b.hasActiveError();b.unsetActiveError();if(a){b.updateLayout()}}});Ext.define("NLeSC.eEcology.form.field.TrackerSelector",{extend:Ext.form.FieldContainer,alias:"widget.trackergridselector",fieldLabel:"Trackers",name:"trackers",labelAttrTpl:'data-qtip="Selected tracker identifiers with additional data"',mixins:{bindable:Ext.util.Bindable,field:Ext.form.field.Field},dragText:"{0} Tracker{1}",msgTarget:"under",value:[],allowBlank:false,blankText:"One or more selected trackers are required",hideNavIcons:false,buttons:["top","up","add","remove","down","bottom"],buttonsText:{top:"Move to Top",up:"Move Up",add:"Add to Selected",remove:"Remove from Selected",down:"Move Down",bottom:"Move to Bottom"},defaults:{flex:1},layout:{type:"hbox",align:"stretch"},autoWidth:true,height:300,initComponent:function(){var a=this;a.items=a.setupItems();a.callParent();a.initField()},createList:function(a){var b=this;a.disabled=b.disabled;a.margins="0 2 0 0";if(!a.viewConfig){a.viewConfig={}}if(!a.viewConfig.plugins){a.viewConfig.plugins=[]}if(Ext.isObject(a.viewConfig.plugins)){a.viewConfig.plugins=[a.viewConfig.plugins]}a.viewConfig.plugins.push({ptype:"gridviewdragdrop",ddGroup:b.ddGroup,dragText:b.dragText});var c=Ext.create("Ext.grid.Panel",a);c.addListener("itemdblclick",b.onItemDblClick,b);c.getView().addListener("drop",b.onSelectedDrop,b);return c},createButtons:function(){var b=this,a=[];if(!b.hideNavIcons){Ext.Array.forEach(b.buttons,function(c){a.push({xtype:"button",tooltip:b.buttonsText[c],handler:b["on"+Ext.String.capitalize(c)+"BtnClick"],cls:Ext.baseCSSPrefix+"form-itemselector-btn",iconCls:Ext.baseCSSPrefix+"form-itemselector-"+c,navBtn:true,scope:b,margin:"4 0 0 0"})})}return a},createFromGrid:function(){var b=this;var a=Ext.create("NLeSC.eEcology.grid.Trackers",{title:"Available",multiSelect:true,disabled:b.disabled,margins:"0 2 0 0",viewConfig:{plugins:[{ptype:"gridviewdragdrop",ddGroup:b.ddGroup,dragText:b.dragText}]}});a.addListener("itemdblclick",b.onItemDblClick,b);a.getView().addListener("drop",b.onAvailableDrop,b);return a},createToGridConfig:function(){var c=this;var a=Ext.create("Ext.data.Store",{model:c.fromField.getStore().model});var b=[];c.fromField.columns.forEach(function(d){b.push(d.cloneConfig())});return{title:"Selected",store:a,multiSelect:true,columns:b}},setupItems:function(){var a=this;a.ddGroup="TrackerGridSelectorDD-"+Ext.id();a.fromField=a.createFromGrid();if(!("toGrid" in a)){a.toGrid=a.createToGridConfig()}if(!a.toGrid.viewConfig){a.toGrid.viewConfig={}}a.toGrid.viewConfig.emptyText=a.blankText;a.toGrid.viewConfig.deferEmptyText=false;a.toField=a.createList(a.toGrid);var b=a.toField.store;b.on("add",this.add2SelectedStore,this);return[a.fromField,{xtype:"container",margins:"0 4",flex:0,layout:{type:"vbox",pack:"center"},items:a.createButtons()},a.toField]},add2SelectedStore:function(a,b){var c=Ext.create(a.model);b.forEach(function(d){c.fields.each(function(e){if(!(e.name in d.fields.keys)){d.fields.add(e)}if(!(e.name in d.data)){d.set(e.name,e.defaultValue)}})})},getSelections:function(b){var a=b.getStore();return Ext.Array.sort(b.getSelectionModel().getSelection(),function(d,c){d=a.indexOf(d);c=a.indexOf(c);if(d<c){return -1}else{if(d>c){return 1}}return 0})},onTopBtnClick:function(){var c=this.toField,a=c.getStore(),b=this.getSelections(c);a.suspendEvents();a.remove(b,true);a.insert(0,b);a.resumeEvents();c.getSelectionModel().select(b);this.syncValue()},onBottomBtnClick:function(){var c=this.toField,a=c.getStore(),b=this.getSelections(c);a.suspendEvents();a.remove(b,true);a.add(b);a.resumeEvents();c.getSelectionModel().select(b);this.syncValue()},onUpBtnClick:function(){var f=this.toField,b=f.getStore(),e=this.getSelections(f),g,d=0,a=e.length,c=0;b.suspendEvents();for(;d<a;++d,c++){g=e[d];c=Math.max(c,b.indexOf(g)-1);b.remove(g,true);b.insert(c,g)}b.resumeEvents();f.getSelectionModel().select(e);this.syncValue()},onDownBtnClick:function(){var e=this.toField,a=e.getStore(),d=this.getSelections(e),f,c=d.length-1,b=a.getCount()-1;a.suspendEvents();for(;c>-1;--c,b--){f=d[c];b=Math.min(b,a.indexOf(f)+1);a.remove(f,true);a.insert(b,f)}a.resumeEvents();e.getSelectionModel().select(d);this.syncValue()},onAddBtnClick:function(){var b=this,a=b.getSelections(b.fromField);b.moveRec(true,a);b.toField.getSelectionModel().select(a)},onRemoveBtnClick:function(){var b=this,a=b.getSelections(b.toField);b.moveRec(false,a);b.fromField.getSelectionModel().select(a)},onSelectedDrop:function(){this.syncValue()},onAvailableDrop:function(){this.syncValue()},moveRec:function(f,e){var c=this,g=c.fromField,a=c.toField,b=f?g.store:a.store,d=f?a.store:g.store;b.remove(e);d.add(e);c.syncValue()},onItemDblClick:function(a,b){this.moveRec(a===this.fromField.getView(),b)},setValue:function(d){var b=this;var a=this.fromField.store;var c=this.toField.store;if(a.getTotalCount()+c.getTotalCount()==0){a.addListener("load",function(){b.setValue(d)},b,{single:true});return}Ext.Array.forEach(c.getRange(),function(e){c.remove(e);a.add(e)});Ext.Array.forEach(d,function(f){if(!(f.$className)){f=Ext.create(Ext.ModelManager.getModel(c.model),f)}var e=a.data.indexOfKey(f.getId());if(e>-1){a.removeAt(e)}c.add(f)});this.syncValue()},syncValue:function(){var a=this;a.mixins.field.setValue.call(a,a.setupValue(a.toField.store.getRange()))},onBindStore:function(a,b){var c=this;if(c.fromField){c.fromField.store.removeAll();c.toField.store.removeAll();if(a.getCount()){c.populateFromStore(a)}else{c.store.on("load",c.populateFromStore,c)}}},populateFromStore:function(a){var b=this.fromField.store;this.fromStorePopulated=true;b.add(a.getRange());b.fireEvent("load",b)},onEnable:function(){var a=this;a.callParent();a.fromField.enable();a.toField.enable();Ext.Array.forEach(a.query("[navBtn]"),function(b){b.enable()})},onDisable:function(){var a=this;a.callParent();a.fromField.disable();a.toField.disable();Ext.Array.forEach(a.query("[navBtn]"),function(b){b.disable()})},onDestroy:function(){this.bindStore(null);this.callParent()},setupValue:function(a){return a.map(function(b){return b.data})},getValue:function(){return this.setupValue(this.toField.store.data.items)||[]},getSubmitValue:function(){return Ext.JSON.encode(this.getValue())},isValid:function(){var b=this,a=b.disabled,c=b.forceValidation||!a;return c?b.validateValue(b.value):a},validateValue:function(b){var a=this,d=a.getErrors(b),c=Ext.isEmpty(d);if(!a.preventMark){if(c){a.clearInvalid()}else{a.markInvalid(d)}}return c},markInvalid:function(c){var b=this,a=b.getActiveError();b.setActiveErrors(Ext.Array.from(c));if(a!==b.getActiveError()){b.updateLayout()}},clearInvalid:function(){var b=this,a=b.hasActiveError();b.unsetActiveError();if(a){b.updateLayout()}},getErrors:function(b){var a=this;var c=[];b=Ext.Array.from(b||a.getValue());numSelected=b.length;if(!a.allowBlank&&numSelected<1){c.push(a.blankText)}return c}});